# プロンプト分類・ワイルドカード生成ツール 要件定義書

## 1. プロジェクト概要

### 1.1 目的
テキストファイルから読み込んだプロンプトを自動分類し、YAML形式のワイルドカードを生成するツールを開発する。

### 1.2 対象ユーザー
- Stable Diffusion ユーザー
- AI画像生成でワイルドカードを使用するユーザー

### 1.3 成果物
- プロンプト分類エンジン（Python）
- **2つの出力モード:**
  1. YAML生成機能（ワイルドカード用）
  2. テキスト抽出・並べ機能（Stable Diffusion用）
- GUI（スタンドアロンデスクトップアプリ）
- 出力ファイル:
  - YAMLワイルドカード
  - カテゴリ別抽出テキストファイル

---

## 2. 機能要件

### 2.1 入力機能

#### 2.1.1 テキストファイル読み込み
- **形式**: `.txt` ファイル
- **エンコーディング**: UTF-8
- **内容**: カンマ区切りのプロンプト
  - 例: `long hair, blue eyes, smile, school uniform, classroom`
- **複数行対応**: 1行 = 1プロンプトセット

#### 2.1.2 入力パターン
```
# パターン1: 単一行
long hair, blue eyes, smile, school uniform, classroom

# パターン2: 複数行
long hair, blue eyes, smile, school uniform, classroom
short hair, red eyes, angry, bikini, beach
twin braids, green eyes, embarrassed, dress, garden
```

---

### 2.2 分類機能

#### 2.2.1 分類カテゴリ（6種類）

| カテゴリ名 | 英語名 | 含まれる要素 |
|----------|--------|------------|
| 顔 | `characterface` | 髪型、目の色、髪色、目の形、唇の形、顔の特徴 |
| 服装 | `clothing` | 服、アクセサリー、靴、下着 |
| ポーズ・表情 | `poseemotion` | 姿勢、動作、表情、感情 |
| 背景 | `backgrounds` | 場所、環境、シーン |
| 体の特徴 | `characterbody` | 体型、肌の色、身長、体格 |
| その他 | `uncategorized` | 分類不能なタグ |

#### 2.2.2 分類ルール

**顔（characterface）のキーワード例:**
- 髪型: `long hair`, `short hair`, `twin braids`, `ponytail`, `braid`
- 目の色: `blue eyes`, `red eyes`, `green eyes`, `heterochromia`
- 髪色: `blonde hair`, `black hair`, `pink hair`, `white hair`
- 目の形: `sharp eyes`, `tareme`, `tsurime`
- 唇: `lips`, `lipstick`, `open mouth`

**服装（clothing）のキーワード例:**
- 服: `dress`, `skirt`, `shirt`, `bikini`, `school uniform`, `kimono`
- アクセサリー: `necklace`, `earrings`, `bracelet`
- 下着: `underwear`, `bra`, `panties`

**ポーズ・表情（poseemotion）のキーワード例:**
- 表情: `smile`, `angry`, `embarrassed`, `surprised`, `blush`
- ポーズ: `standing`, `sitting`, `lying`, `bent over`, `all fours`
- 動作: `running`, `jumping`, `reaching`, `stretching`

**背景（backgrounds）のキーワード例:**
- 場所: `classroom`, `beach`, `garden`, `bedroom`, `street`
- 環境: `indoors`, `outdoors`, `night`, `sunset`

**体の特徴（characterbody）のキーワード例:**
- 体型: `petite`, `curvy`, `muscular`, `tall`, `short`
- 肌: `pale skin`, `dark skin`, `tan`
- 胸: `large breasts`, `small breasts`, `cleavage`

#### 2.2.3 分類アルゴリズム
1. タグを `,` で分割
2. 各タグの小文字化
3. キーワード辞書とマッチング
4. 最初にマッチしたカテゴリに分類
5. マッチしなかった場合は `uncategorized`

---

### 2.3 テキスト抽出・並べ機能（新規）

#### 2.3.1 機能概要
複数のtxtファイルから特定カテゴリのタグだけを抽出し、改行区切りのテキストファイルとして出力する。

#### 2.3.2 用途
- Stable Diffusion の "Prompts from file or textbox" 機能用
- 異なるポーズを一気に生成したい場合

#### 2.3.3 処理フロー
1. フォルダ選択（複数txtファイルを含む）
2. **カテゴリ選択（複数選択可能）**
   - [ ] characterface（顔）
   - [✓] clothing（服装）
   - [✓] poseemotion（ポーズ）
   - [ ] backgrounds（背景）
   - [ ] characterbody（体の特徴）
   - [ ] uncategorized（その他）
   - [✓] **全て選択**
3. 各ファイルから該当カテゴリのタグを抽出
4. 1ファイル = 1行として並べる
5. テキストファイルまたはクリップボードに出力

#### 2.3.4 入力例
```
フォルダ: C:\Users\user\Downloads\2025みなみハロウィン\

- paid_0124.txt:
  all fours, breasts, open mouth, blush, cleavage, :d, teeth, ...

- paid_0125.txt:
  ass, breasts, looking at viewer, blush, looking back, cowboy shot, ...

- paid_0126.txt:
  girl, squatting, solo, breasts, armpits, large breasts, ...
```

#### 2.3.5 出力例

**パターン1: poseemotion のみ抽出**
```
all fours,open mouth,blush,:d,
looking at viewer,blush,looking back,cowboy shot,from below,from behind,standing,looking down,
squatting,looking at viewer,blush,from below,arm up,
sitting,smile,blush,closed mouth,dutch angle,
outstretched arms,spread arms
```

**パターン2: clothing + poseemotion を抽出**
```
all fours,open mouth,blush,:d,breasts,cleavage,
looking at viewer,blush,looking back,cowboy shot,from below,from behind,standing,looking down,ass,breasts,
squatting,looking at viewer,blush,from below,arm up,breasts,armpits,large breasts,
sitting,smile,blush,closed mouth,dutch angle,thighs,stomach,sweat,
outstretched arms,spread arms
```

**パターン3: characterface のみ抽出**
```
open mouth,:d,teeth,upper teeth only,lips,
looking at viewer,looking back,
looking at viewer,
closed mouth,crossed bangs,
```

#### 2.3.6 ファイル命名規則
```
prompts_extracted_[categories]_YYYYMMDD.txt

例:
- 単一カテゴリ: prompts_extracted_poseemotion_20251010.txt
- 複数カテゴリ: prompts_extracted_clothing+poseemotion_20251010.txt
- 全カテゴリ: prompts_extracted_all_20251010.txt
```

---

### 2.4 YAML生成機能

#### 2.4.1 出力形式（StabilityMatrix互換ワイルドカード）

**ワイルドカードの仕組み:**
- `character_main` セクション: 全カテゴリを組み合わせるテンプレート
- `__カテゴリ名__` 形式: 該当カテゴリからランダムに1つ選択
- 各カテゴリセクション: 実際のタグリスト

**出力例:**
```yaml
character_main:
  - "1girl, solo, __characterface__, __characterbody__, __clothing__, __poseemotion__, __backgrounds__, __uncategorized__"

characterface:
  - "brown hair, hair ornament, hairclip, pink eyes, purple eyes, long hair, short hair, medium hair"
  - "brown hair, hair ornament, blush, bangs, purple eyes, medium hair, long hair, braid, pink eyes, short hair"
  - "hair ornament, brown hair, purple eyes, hairclip, medium hair, pink eyes, shiny hair, short hair"

clothing:
  - "torn clothes, thighhighs, hairclip, corset, boots, dress, thigh boots, wrist cuffs, torn dress, puffy sleeves"
  - "witch hat, hat, thighhighs, boots, thigh boots, panties, underwear, hairclip, black panties"
  - "thighhighs, boots, high heel boots, high heels, torn clothes, thigh boots, dress, puffy sleeves"

poseemotion:
  - "open mouth, looking at viewer, kneeling"
  - "arms up, open mouth, looking at viewer, cowboy shot"
  - "looking at viewer, smile, looking back, spread anus, ass focus, from behind, spread ass, closed mouth, all fours, back"

backgrounds:
  - "jack-o'-lantern, halloween, night, pumpkin, moon, tree, outdoors, full moon, bare tree, night sky, sky"
  - "halloween, jack-o'-lantern, ghost, pumpkin, night"

characterbody:
  - "1girl, breasts, nipples, solo, large breasts, sweat, thighs, shiny, shiny skin"
  - "1girl, breasts, anus, large breasts, ass, solo focus, partially visible vulva, hetero, 1boy, sideboob, thighs"

uncategorized:
  - "short sleeves, no bra"
  - "censored, mosaic censoring, dildo, sex toy"
```

#### 2.4.2 ワイルドカード参照の動作

StabilityMatrixでプロンプト生成時:
1. `character_main` の行を選択
2. `__characterface__` → `characterface` セクションからランダムに1行選択
3. `__characterbody__` → `characterbody` セクションからランダムに1行選択
4. `__clothing__` → `clothing` セクションからランダムに1行選択
5. すべてのカテゴリを組み合わせて最終プロンプトを生成

**例:**
```
入力: __characterface__, __clothing__

出力: brown hair, hair ornament, hairclip, pink eyes, purple eyes, long hair, short hair, medium hair, torn clothes, thighhighs, hairclip, corset, boots, dress, thigh boots, wrist cuffs, torn dress, puffy sleeves
```

#### 2.4.3 YAML形式の仕様

**必須要件:**
- **インデント**: 2スペース
- **引用符**: ダブルクォート `"` で囲む
- **エンコーディング**: UTF-8
- **セクション順序**:
  1. `character_main` （必須・最初）
  2. `characterface`
  3. `clothing`
  4. `poseemotion`
  5. `backgrounds`
  6. `characterbody`
  7. `uncategorized`

#### 2.4.4 行ごとのタグ保存

- **1入力行 = 1YAMLエントリー**
- 各行から該当カテゴリのタグを抽出し、カンマ区切りで保存
- 重複排除は**行ごと**に実施（全体では重複あり）

**入力例:**
```
brown hair, blue eyes, smile, school uniform, classroom, large breasts
short hair, red eyes, angry, bikini, beach, small breasts
```

**出力例:**
```yaml
characterface:
  - "brown hair, blue eyes, smile"
  - "short hair, red eyes, angry"

clothing:
  - "school uniform"
  - "bikini"

backgrounds:
  - "classroom"
  - "beach"

characterbody:
  - "large breasts"
  - "small breasts"
```

#### 2.4.5 ファイル命名規則
```
prompts_classified_YYYYMMDD.yaml

例: prompts_classified_20251026.yaml
```

---

### 2.5 GUI機能（スタンドアロンアプリ）

#### 2.5.1 アプリ特性
- **形態**: Tkinter ベースのデスクトップアプリケーション
- **ポート**: 不使用（Webサーバーなし）
- **起動**: `.exe` または `python gui_app.py` で起動
- **オフライン**: 完全オフライン動作

#### 2.5.2 画面構成
```
┌─────────────────────────────────────────────────┐
│ プロンプト分類ツール                              │
├─────────────────────────────────────────────────┤
│ ■ YAML生成モード                                │
│ [ファイル選択] [分類実行] [YAML生成]              │
│                                                 │
│ ■ テキスト抽出モード                             │
│ [フォルダ選択]                                   │
│ カテゴリ選択: [ ] 顔 [✓] 服装 [✓] ポーズ ...    │
│                [ ] 背景 [ ] 体 [✓] 全て選択     │
│ [テキスト抽出]                                   │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ プレビュー                                   │ │
│ │                                             │ │
│ │ all fours,open mouth,blush,:d,              │ │
│ │ looking at viewer,blush,looking back,...    │ │
│ │ squatting,looking at viewer,blush,...       │ │
│ │                                             │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ [クリップボードにコピー] [ファイル保存]            │
│                                                 │
└─────────────────────────────────────────────────┘
```

#### 2.5.3 操作フロー

**パターンA: YAML生成モード**
1. 「ファイル選択」ボタン → txtファイル選択
2. 「分類実行」ボタン → 自動分類実行
3. 分類結果プレビュー表示
4. 「YAML生成」ボタン → YAMLファイル生成
5. 「クリップボードにコピー」または「ファイル保存」

**パターンB: テキスト抽出モード**
1. 「フォルダ選択」ボタン → フォルダ選択（複数txtファイル含む）
2. **カテゴリ選択チェックボックス** → 抽出したいカテゴリを選択（複数可）
   - 例1: [✓] poseemotion のみ
   - 例2: [✓] clothing + [✓] poseemotion
   - 例3: [✓] characterface のみ
   - 例4: [✓] 全て選択
3. 「テキスト抽出」ボタン → 抽出実行
4. プレビュー表示（1ファイル = 1行、選択カテゴリのタグのみ）
5. 「クリップボードにコピー」→ Stable Diffusionに貼り付け

---

## 3. 非機能要件

### 3.1 パフォーマンス
- 10,000行のテキストを10秒以内に処理
- メモリ使用量: 500MB以下

### 3.2 互換性
- Python 3.8以上
- Windows 10/11対応（メインターゲット）
- macOS/Linux対応（Tkinterは標準サポート）
- StabilityMatrix互換のYAML形式
- **インターネット接続不要**（完全オフライン動作）
- **Webサーバー不要**（ポート使用なし）

### 3.3 使いやすさ
- GUI操作のみで完結
- エラーメッセージは日本語で表示
- プレビュー機能で結果確認

---

## 4. 技術仕様

### 4.1 アーキテクチャ
- **アプリ形態**: スタンドアロンデスクトップアプリ
- **ポート**: 不要（Webサーバー不使用）
- **起動方法**: ダブルクリックで起動可能な `.exe` または Python スクリプト
- **依存関係**: 最小限（PyYAMLのみ）

### 4.2 使用技術
- **言語**: Python 3.8+
- **GUI**: Tkinter（Python標準ライブラリ、追加インストール不要）
- **YAML処理**: PyYAML
- **エンコーディング**: UTF-8
- **配布形式**:
  - Python スクリプト版（.py）
  - 実行ファイル版（.exe、PyInstallerでビルド）

### 4.3 ディレクトリ構成
```
C:\metacard\
├── prompt_classifier.py         # 分類エンジン
├── keyword_database.py          # キーワード辞書
├── gui_app.py                   # GUIアプリ
├── requirements.txt             # 依存パッケージ
├── input/                       # 入力ファイル置き場
│   └── prompts.txt
└── output/                      # 出力YAML置き場
    └── prompts_classified_*.yaml
```

### 4.4 依存パッケージ
```
PyYAML==6.0.1
```

---

## 5. 開発フェーズ

### Phase 1: キーワード辞書作成 ✅
- [x] 各カテゴリのキーワードリスト作成（1020個）
- [x] keyword_database.py 実装

### Phase 2: 分類エンジン開発 ✅
- [x] タグ分割・正規化処理
- [x] キーワードマッチング処理
- [x] prompt_classifier.py 実装

### Phase 3: 出力機能開発 ✅
- [x] YAML形式変換
- [x] テキスト抽出機能（複数ファイル + カテゴリ選択）
- [x] 重複排除処理（setを使用）
- [x] ファイル保存処理

### Phase 4: GUI開発 ✅
- [x] Tkinter GUI構築
- [x] ファイル/フォルダ選択ダイアログ
- [x] カテゴリ選択チェックボックス（複数選択対応）
- [x] 2モード切替（YAML生成 / テキスト抽出）
- [x] プレビュー表示
- [x] クリップボードコピー機能

### Phase 5: テスト ✅
- [x] サンプルデータでのテスト
- [x] エラーハンドリング確認
- [x] StabilityMatrix互換性確認

---

## 6. 制約事項

### 6.1 技術的制約
- キーワード辞書に登録されていないタグは `uncategorized` に分類される
- 完全一致のみ対応（部分一致は未対応）
- 日本語タグは未対応（英語タグのみ）

### 6.2 運用制約
- 初回起動時にキーワード辞書を手動で拡充する必要がある
- 大量データ（10万行以上）では動作が遅くなる可能性

---

## 7. 今後の拡張性

### 7.1 Phase 2 機能（将来）
- タグの部分一致対応
- 日本語タグ対応
- 機械学習による自動分類
- カスタムカテゴリ追加機能

### 7.2 Phase 3 機能（将来）
- Web UI版
- バッチ処理対応
- 既存YAMLとのマージ機能

---

## 8. 成功基準

### 8.1 定量的指標
- 分類精度: 90%以上
- 処理速度: 1000行/秒以上
- GUI応答速度: 1秒以内

### 8.2 定性的指標
- ユーザーが直感的に操作できる
- 生成されたYAMLがStabilityMatrixで正常動作する
- エラーが発生しても明確なメッセージが表示される

---

## 9. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| キーワード辞書の不足 | 高 | 拡張可能な設計、ユーザーがカスタマイズ可能に |
| 大量データでの性能低下 | 中 | チャンク処理、プログレスバー表示 |
| YAML形式の非互換 | 高 | StabilityMatrix実機テスト必須 |

---

## 10. スケジュール

| フェーズ | 期間 | 成果物 |
|---------|------|--------|
| Phase 1 | 1時間 | keyword_database.py |
| Phase 2 | 2時間 | prompt_classifier.py |
| Phase 3 | 2時間 | YAML生成 + テキスト抽出機能 |
| Phase 4 | 4時間 | GUI完成（2モード対応） |
| Phase 5 | 1時間 | テスト完了 |
| **合計** | **10時間** | **完成版ツール** |

---

## 11. 承認

- [x] 要件定義書レビュー完了
- [x] 開発開始承認
- [x] 実装フェーズ移行
- [x] **全Phase完了（2025-10-26）**
- [x] **アプリケーション完成**


---

## 12. 変更履歴

### 2025-10-26: YAML生成機能の修正
- **問題**: YAML生成時に全行のタグが集約され、行ごとの構造が失われていた
- **原因**: `classify_file()`がset-based集約を行っていた
- **修正**: 
  - `prompt_classifier.py`に`classify_file_for_yaml()`関数を追加
  - 行ごとのタグをカンマ区切り文字列のリストとして保持
  - `gui_app.py`の`generate_yaml()`を更新して新関数を使用
- **結果**: StabilityMatrix互換のYAML形式が正しく生成されるようになった

**修正前の出力（誤り）**:
```yaml
characterface:
  - blue eyes
  - brown eyes
  - green eyes
  - long hair
  - red eyes
  - short hair
  - twin braids
```

**修正後の出力（正しい）**:
```yaml
characterface:
  - long hair, blue eyes
  - short hair, red eyes
  - twin braids, green eyes
  - ponytail, brown eyes
```

### 2025-10-26: ワイルドカード参照システムの追加
- **問題**: YAMLにワイルドカード参照テンプレート（character_main）が存在せず、StabilityMatrixでカテゴリを組み合わせて使用できなかった
- **原因**: YAML生成時にcharacter_mainセクションを出力していなかった
- **修正**:
  - `gui_app.py`の`generate_yaml()`メソッドを更新
  - YAML手動生成に変更（yaml.dump()から独自フォーマット生成へ）
  - character_mainセクションを先頭に追加
  - 2スペースインデント、ダブルクォート囲みに統一
  - セクション順序を規定（character_main → characterface → clothing → ...）
- **結果**:
  - StabilityMatrix互換のワイルドカード形式で出力
  - `__characterface__`、`__characterbody__` などで各カテゴリを参照可能
  - 全カテゴリを組み合わせたプロンプト生成が可能に

**修正後の出力（ワイルドカード対応）**:
```yaml
character_main:
  - "1girl, solo, __characterface__, __characterbody__, __clothing__, __poseemotion__, __backgrounds__, __uncategorized__"

characterface:
  - "brown hair, hair ornament, hairclip, pink eyes, purple eyes, long hair, short hair, medium hair"
  - "brown hair, hair ornament, blush, bangs, purple eyes, medium hair, long hair, braid, pink eyes, short hair"

clothing:
  - "torn clothes, thighhighs, hairclip, corset, boots, dress, thigh boots, wrist cuffs, torn dress, puffy sleeves"
  ...
```

